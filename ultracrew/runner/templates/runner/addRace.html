{% extends 'layout.html'%}

{% block content %}
    <h3>Add a Race</h3>
    <div class="divider"></div>
    <div id="raceForm">
        <form action="{% url 'runner:addRace' %}" method="POST">
            {% csrf_token %}
            {{raceform.as_p}}
            {{regform.as_p}}
            <div id="aidStationForms">
                <h4>Aid Stations</h4>
                {{stationforms.management_form}}
                {% for station in stationforms %}
                    <div class="stationForm" id="station-{{ forloop.counter0 }}">
                        {{ station.as_table }}
                        <br>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="addStationButton">Add Aid Station</button>
            <input type="submit" value="Create Race">
        </form> 
    </div>
    {% load static %}
    <!-- <script src="{% static 'runner/addRace.js'%}"></script> -->
    <script>
        const totalFormsID = "id_station-TOTAL_FORMS";
        const idFragment = "station-"
        document.addEventListener('DOMContentLoaded', function() {
            var button = document.getElementById("addStationButton");
            button.addEventListener('click', function() {
                let totalFormsManager = document.getElementById(totalFormsID);
                let curNumForms = totalFormsManager.value;
                existingForm = document.getElementById(idFragment+(curNumForms-1));
                newForm = existingForm.cloneNode(true);
                recursiveIdNameForReplace(newForm, idFragment+(curNumForms-1), idFragment+(curNumForms))
                existingForm.parentNode.appendChild(newForm);
                totalFormsManager.value++;
            });
        });

        function recursiveIdNameForReplace(node, oldString, newString)
        {
            node.id = node.id.replace(oldString, newString);
            
            if (node.for)
            {
                node.for = node.for.replace(oldString, newString);
            }
            
            if (node.name)
            {
                node.name = node.name.replace(oldString, newString);
            }

            node.value = "";
            children = node.children;
            for (child of children)
            {
                recursiveIdNameForReplace(child, oldString, newString);
            }
            return
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/html-duration-picker@latest/dist/html-duration-picker.min.js"></script>
{% endblock %}